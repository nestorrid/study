# ORM查询

## select语句

基础查询, 通过`select`对象创建查询, 然后通过session的`execute`执行即可获得结果.

```python
from sqlalchemy import select
stmt = select(User).where(User.name == "spongebob")

result = session.execute(stmt)
for user_obj in result.scalars():
    print(f"{user_obj.name} {user_obj.fullname}")
```

在使用`execute`方法获得的是一个row对象, 本质是一个元组, 仅包含一个实体对象

```python
result.all()
"""
[(User(id=1, name='spongebob', fullname='Spongebob Squarepants'),),
 (User(id=2, name='sandy', fullname='Sandy Cheeks'),),
 (User(id=3, name='patrick', fullname='Patrick Star'),),
 (User(id=4, name='squidward', fullname='Squidward Tentacles'),),
 (User(id=5, name='ehkrabs', fullname='Eugene H. Krabs'),)]
"""
```

对于查询具体的实体对象, 可以直接跳过生成Row对象, 而获得具体的实体对象. 直接使用`session.scalars()`方法进行查询, 便可以获得具体的实体对象.

```python
session.scalars(select(User).order_by(User.id)).all()
"""
[User(id=1, name='spongebob', fullname='Spongebob Squarepants'),
 User(id=2, name='sandy', fullname='Sandy Cheeks'),
 User(id=3, name='patrick', fullname='Patrick Star'),
 User(id=4, name='squidward', fullname='Squidward Tentacles'),
 User(id=5, name='ehkrabs', fullname='Eugene H. Krabs')]
"""
```

### 同时查询多个表

```python
stmt = select(User, Address).join(User.addresses).order_by(User.id, Address.id)
for row in session.execute(stmt):
    print(f"{row.User.name} {row.Address.email_address}")
```

### 查询特定的属性

```python
result = session.execute(
    select(User.name, Address.email_address)
    .join(User.addresses)
    .order_by(User.id, Address.id)
)
```

### 使用原生SQL语句查询

```python
from sqlalchemy import text
textual_sql = text("SELECT id, name, fullname FROM user_account ORDER BY id")

orm_sql = select(User).from_statement(textual_sql)
for user_obj in session.execute(orm_sql).scalars():
    print(user_obj)
```

### 子查询

可以通过`subquery()`方法创建子查询

```python
inner_stmt = select(User).where(User.id < 7).order_by(User.id)
subq = inner_stmt.subquery()
aliased_user = aliased(User, subq)
stmt = select(aliased_user)
for user_obj in session.execute(stmt).scalars():
    print(user_obj)
    
"""
 SELECT anon_1.id, anon_1.name, anon_1.fullname
FROM (SELECT user_account.id AS id, user_account.name AS name, user_account.fullname AS fullname
FROM user_account
WHERE user_account.id < ? ORDER BY user_account.id) AS anon_1
[generated in ...] (7,)

User(id=1, name='spongebob', fullname='Spongebob Squarepants')
User(id=2, name='sandy', fullname='Sandy Cheeks')
User(id=3, name='patrick', fullname='Patrick Star')
User(id=4, name='squidward', fullname='Squidward Tentacles')
User(id=5, name='ehkrabs', fullname='Eugene H. Krabs')
"""
```

### 集合操作

如通过`union_all()`将多个查询的结果集进行合并等

```python
from sqlalchemy import union_all
u = union_all(
    select(User).where(User.id < 2), select(User).where(User.id == 3)
).order_by(User.id)
stmt = select(User).from_statement(u)
for user_obj in session.execute(stmt).scalars():
    print(user_obj)
    
"""
SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account
WHERE user_account.id < ? UNION ALL SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account
WHERE user_account.id = ? ORDER BY id
[generated in ...] (2, 3)
"""    
```

### Join子句

> #### note
>
> 在SQLAlchemy2.0以后得版本中, 使用`select().join()`来进行关联查询. `Query().join()`属于1.x版本的使用方式.

```python
stmt = select(User).join(User.addresses)
print(stmt)

"""
SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account JOIN address ON user_account.id = address.user_id
"""
```

`join()`子句可以包含多种形式:

* `join(User.address)`: 直接使用查询表的关系字段, 相当于`User.id = Address.user_id`

* `join(Address)`: 直接使用关联表的实体, 此时会默认根据两个实体的外键关系进行查询

* `join(Address, User.id == Address.user_id)`: 显示的指定`on`子句, 可读性最高

* `join(subquery)`: 关联子查询

  * ```python
    subq = select(Address).where(Address.email_address == "pat999@aol.com").subquery()
    stmt = select(User).join(subq, User.id == subq.c.user_id)
    print(stmt)
    
    """
    SELECT user_account.id, user_account.name, user_account.fullname
    FROM user_account
    JOIN (SELECT address.id AS id,
    address.user_id AS user_id, address.email_address AS email_address
    FROM address
    WHERE address.email_address = :email_address_1) AS anon_1
    ON user_account.id = anon_1.user_id
    """
    ```

同时`join()`子句可以进行连用, 即关联多个表:

```python
stmt = select(User).join(User.orders).join(Order.items).join(User.addresses)
print(stmt)
"""
SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account
JOIN user_order ON user_account.id = user_order.user_id
JOIN order_items AS order_items_1 ON user_order.id = order_items_1.order_id
JOIN item ON item.id = order_items_1.item_id
JOIN address ON user_account.id = address.user_id
"""
```



### 练习

```python
import pytest

from sqlalchemy import create_engine, select
from sqlalchemy.orm import Session

from .models import Base, User, Address


engine = create_engine('sqlite:///select.sqlite', echo=True)


@pytest.fixture(scope='module', autouse=True)
def init_database():
    Base.metadata.drop_all(engine)
    Base.metadata.create_all(engine)

    with Session(engine) as session:
        address = Address(street='some street', zipcode='1111')
        user = User(name='test user')
        user.address = [address]
        session.add(user)
        user = User(name='noaddress user')
        session.add(user)
        session.commit()


@pytest.fixture
def session():
    with Session(engine) as session:
        with session.begin():
            yield session


def test_success():
    pass


def test_select_join(session):
    stmt = select(User).join(User.address)
    results = session.scalars(stmt).all()
    print(stmt)
    print(results)
    assert results[0].name == 'test user' and results[0].address[0].street == 'some street'


def test_select_join_entity(session):
    stmt = select(User).join(Address)
    results = session.scalars(stmt).all()
    print(stmt)
    print(results)
    assert results[0].name == 'test user' and results[0].address[0].street == 'some street'


def test_select_join_entity_with_on_clause(session):
    stmt = select(User).join(Address, User.id == Address.user_id)
    results = session.scalars(stmt).all()
    print(stmt)
    print(results)
    assert results[0].name == 'test user' and results[0].address[0].street == 'some street'


def test_select_where(session):
    stmt = select(User).where(User.address.any(Address.zipcode.contains('11')))
    results = session.scalars(stmt).all()
    assert len(results) == 1


def test_select_users_without_address(session):
    result = session.scalars(
        select(User).where(~User.address.any())
    ).first()
    assert result.name == 'noaddress user'


def test_select_user_by_id(session):
    user = session.get(User, 1)
    print(user)
    assert user.name == 'test user'

```











