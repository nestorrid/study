# 插入数据

与`select()`语句相同, 插入语句同样可以通过`Session().execute()`来执行

## 插入单条数据

对于单条数据的插入, 可以简单的通过`session().add()`来直接进行添加

```python
def test_insert_single_user(session):
    user = User(name='single user')
    session.add(user)
    assert session.query(User).count() == 1
```

## 插入多条数据

SQLAlchemy在插入数据时可以省略对象的创建, 直接通过json格式的数据进行数据的插入. 可以直接通过`insert().values()`方法直接插入, 或者通过`session().execute()`的`param`参数指定数据.

```python
def test_insert_multiple_users_with_params(session):
    resultset = session.execute(insert(User).returning(User), [
        {'name': f'user-{i}'}
        for i in range(10)
    ])
    print(resultset)
    print(resultset.all())


def test_insert_multiple_users_with_values(session):
    resultset = session.execute(insert(User).values([
        {'name': f'user-{i}'}
        for i in range(10)
    ]).returning(User))
    print(resultset)
    print(resultset.all())
```

## 获取返回数据

当需要使用新插入的数据的或者其中的某个字段时可以通过`returning()`方法来获取. 可以通过指定实体来获得完整行数据, 也可以单独指定所需要的字段.

```python
def test_get_insert_user(session):
    result = session.scalar(
        insert(User).values({'name': 'John'}).returning(User)
    )
    print(result, result.id)
    assert result.name == 'John'


def test_get_insert_user_id(session):
    user_id = session.execute(
        insert(User).values({'name': 'John'}).returning(User.id)
    ).one().id
    print(user_id)
    assert user_id > 0
```

## 插入拥有相同字段的值的多条数据

当插入多条记录, 而所有记录的某些字段具有相同属性时, 可以通过`insert().values()`来设置相同的字段, 然后通过`session().execute()`的`param`参数来指定每条记录具体的数据.

```python

def test_insert_mutiple_address_for_same_user(session):
    user_id = session.execute(insert(User).values(
        {'name': 'multiple addr user'}).returning(User.id)).one().id

    list_addr = [
        {
            'street': f'street {i}',
            'zipcode': f'{i}' * 5,
        }
        for i in range(10)
    ]
    results = session.execute(
        insert(Address).values(user_id=user_id).returning(Address),
        list_addr
    )
    print(results.all())
```

## 关联数据插入

当需要同时插入多个表的数据时, 比如一对多关系的`User`和`Address`表. 可以先通过`insert()`语句插入用户, 并获取其id, 然后再批量插入address

或者通过创建实体对象, 并直接使用`Session().add()`方法一次性插入设置完成的user对象. 便可以同时完成关联表的数据插入.

```python
def test_insert_user_with_multiple_address(session):
    user = User(name='john')
    user.address = [
        Address(street=f'street {i}', zipcode=f'{i}' * 5)
        for i in range(10)
    ]
    session.add(user)
```













